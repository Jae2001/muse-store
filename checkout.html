<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Checkout</title>
  </head>
  <body>
    <h1>ğŸ’³ ç»“è´¦é¡µé¢</h1>
    <div id="cart-list"></div>
    <h2 id="total-amount"></h2>

    <h3>è¯·é€‰æ‹©ä»˜æ¬¾æ–¹å¼ï¼š</h3>
    <div id="payment-methods"></div>

    <button id="submit-order">âœ… æˆ‘å·²è½¬è´¦</button>

    <a href="index.html">â¬…ï¸ è¿”å›å•†åº—</a>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
      import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyD2v-BrgI9EfEMN1tcw6qh4xDXRFtBBcsw",
        authDomain: "muse-store-01.firebaseapp.com",
        projectId: "muse-store-01",
        storageBucket: "muse-store-01.firebasestorage.app",
        messagingSenderId: "590294528151",
        appId: "1:590294528151:web:b7a16dfb58a64d641579d2"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const cart = JSON.parse(localStorage.getItem("cart")) || [];

      // åˆå¹¶ç›¸åŒå•†å“
      const mergedCart = {};
      cart.forEach(item => {
        if (mergedCart[item.name]) {
          mergedCart[item.name].quantity += 1;
        } else {
          mergedCart[item.name] = { ...item, quantity: 1 };
        }
      });

      let total = 0;
      const cartDiv = document.getElementById("cart-list");

      Object.values(mergedCart).forEach(item => {
        cartDiv.innerHTML += `<p>${item.name} - RM${item.price.toFixed(2)} x ${item.quantity}</p>`;
        total += item.price * item.quantity;
      });

      document.getElementById("total-amount").innerText = `ğŸ§¾ æ€»é‡‘é¢ï¼šRM${total.toFixed(2)}`;

      // åŠ è½½ä»˜æ¬¾æ–¹å¼
      async function loadPaymentMethods() {
        const paymentDiv = document.getElementById("payment-methods");
        const snapshot = await getDocs(collection(db, "paymentMethods"));
        snapshot.forEach(doc => {
          const data = doc.data();
          paymentDiv.innerHTML += `
            <div style="margin-bottom:10px;">
              <p><strong>${data.name}</strong></p>
              <img src="${data.imageUrl}" alt="${data.name}" width="200" />
            </div>
          `;
        });
      }

      loadPaymentMethods();

      // æäº¤è®¢å•åˆ° Firebase
      document.getElementById("submit-order").addEventListener("click", async () => {
        if (Object.keys(mergedCart).length === 0) {
          alert("è´­ç‰©è½¦ä¸ºç©ºï¼");
          return;
        }

        const order = {
          items: Object.values(mergedCart),
          total: total,
          createdAt: new Date().toISOString(),
        };

        try {
          await addDoc(collection(db, "orders"), order);
          alert("âœ… è®¢å•å·²æäº¤ï¼");
          localStorage.removeItem("cart");
          window.location.href = "index.html";
        } catch (err) {
          alert("âŒ æäº¤å¤±è´¥ï¼š" + err.message);
        }
      });
    </script>
  </body>
</html>
