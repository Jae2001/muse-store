<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>ğŸ’³ ç»“è´¦é¡µé¢</title>
  </head>
  <body>
    <h1>ğŸ’³ ç»“è´¦é¡µé¢</h1>
    <div id="checkout-list"></div>
    <h2 id="total-checkout-price"></h2>

    <hr />
    <h3>è¯·é€‰æ‹©ä»˜æ¬¾æ–¹å¼ï¼š</h3>
    <select id="payment-method-dropdown">
      <option value="">-- è¯·é€‰æ‹©é“¶è¡Œ --</option>
    </select>

    <div id="payment-details" style="margin-top: 15px;"></div>

    <h3>å¡«å†™è½¬è´¦èµ„æ–™ï¼š</h3>
    <label>Reference No:</label><br />
    <input type="text" id="ref-no" /><br /><br />

    <label>è½¬è´¦æ—¥æœŸ:</label><br />
    <input type="date" id="transfer-date" /><br /><br />

    <label>è½¬è´¦æ—¶é—´:</label><br />
    <input type="time" id="transfer-time" /><br /><br />

    <label>ä¸Šä¼  Bank-in Slip:</label><br />
    <input type="file" id="slip-file" accept="image/*" /><br /><br />

    <button onclick="submitOrder()">âœ… æˆ‘å·²è½¬è´¦</button>

    <br /><br />
    <a href="cart.html">â¬…ï¸ è¿”å›è´­ç‰©è½¦</a><br />
    <a href="index.html">â¬…ï¸ è¿”å›å•†åº—</a>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
      import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyD2v-BrgI9EfEMN1tcw6qh4xDXRFtBBcsw",
        authDomain: "muse-store-01.firebaseapp.com",
        projectId: "muse-store-01",
        storageBucket: "muse-store-01.firebasestorage.app",
        messagingSenderId: "590294528151",
        appId: "1:590294528151:web:b7a16dfb58a64d641579d2"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const dropdown = document.getElementById("payment-method-dropdown");
      const detailsDiv = document.getElementById("payment-details");

      let paymentMethods = [];

      async function loadPaymentMethods() {
        const querySnapshot = await getDocs(collection(db, "paymentMethods"));
        paymentMethods = [];
        dropdown.innerHTML = `<option value="">-- è¯·é€‰æ‹©é“¶è¡Œ --</option>`;

        querySnapshot.forEach((doc) => {
          const data = doc.data();
          paymentMethods.push(data);
          const option = document.createElement("option");
          option.value = data.name;
          option.textContent = data.name;
          dropdown.appendChild(option);
        });
      }

      dropdown.addEventListener("change", () => {
        const selected = paymentMethods.find(method => method.name === dropdown.value);
        if (selected) {
          detailsDiv.innerHTML = `
            <p><strong>é“¶è¡Œåç§°ï¼š</strong> ${selected.name}</p>
            <p><strong>æˆ·å£åç§°ï¼š</strong> ${selected.accountName}</p>
            <p><strong>æˆ·å£å·ç ï¼š</strong> ${selected.accountNumber}</p>
            ${selected.qrImageUrl ? `<img src="${selected.qrImageUrl}" alt="QR Code" width="150">` : ""}
          `;
        } else {
          detailsDiv.innerHTML = "";
        }
      });

      loadPaymentMethods();

      // æ˜¾ç¤ºè´­ç‰©è½¦å•†å“å’Œæ€»é‡‘é¢
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      let total = 0;
      const checkoutList = document.getElementById("checkout-list");

      cart.forEach((item) => {
        checkoutList.innerHTML += `<p>${item.name} - RM${item.price.toFixed(2)} x ${item.quantity}</p>`;
        total += item.price * item.quantity;
      });

      document.getElementById("total-checkout-price").textContent = `ğŸ§¾ æ€»é‡‘é¢ï¼šRM${total.toFixed(2)}`;

      // æäº¤è®¢å•ï¼ˆç¤ºèŒƒï¼‰
      window.submitOrder = function() {
        const refNo = document.getElementById("ref-no").value.trim();
        const date = document.getElementById("transfer-date").value;
        const time = document.getElementById("transfer-time").value;
        const method = document.getElementById("payment-method-dropdown").value;
        const file = document.getElementById("slip-file").files[0];

        if (!refNo || !date || !time || !method || !file) {
          alert("è¯·å¡«å†™æ‰€æœ‰è½¬è´¦èµ„æ–™å¹¶é€‰æ‹©ä»˜æ¬¾æ–¹å¼ï¼Œä¸Šä¼  Bank-in Slipï¼");
          return;
        }

        alert("æäº¤æˆåŠŸï¼ï¼ˆä¸‹ä¸€æ­¥ï¼šä¸Šä¼ å‡­è¯å’Œå­˜å…¥ Firestoreï¼‰ğŸ‰");
      }
    </script>
  </body>
</html>
